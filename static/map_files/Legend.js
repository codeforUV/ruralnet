// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.35/esri/copyright.txt for details.
//>>built
require({cache:{"dojo/debounce":function(){define([],function(){return function(M,R){var A;return function(){A&&clearTimeout(A);var r=this,G=arguments;A=setTimeout(function(){M.apply(r,G)},R)}}})},"esri/numberUtils":function(){define(["dojo/has","dojo/number","dojo/i18n!dojo/cldr/nls/number","./kernel"],function(M,R,A,r){var G=function(u,y){return u-y},S={_reNumber:/^-?(\d+)(\.(\d+))?$/i,getDigits:function(u){var y=String(u),v=y.match(S._reNumber);u={integer:0,fractional:0};v&&v[1]?(u.integer=v[1].split("").length,
u.fractional=v[3]?v[3].split("").length:0):-1<y.toLowerCase().indexOf("e")&&(v=y.split("e"),y=v[0],v=v[1],y&&v&&(y=Number(y),v=Number(v),(u=0<v)||(v=Math.abs(v)),y=S.getDigits(y),u?(y.integer+=v,y.fractional=v>y.fractional?0:y.fractional-v):(y.fractional+=v,y.integer=v>y.integer?1:y.integer-v),u=y));return u},getFixedNumbers:function(u,y){var v=Number(u.toFixed(y));v<u?u=v+1/Math.pow(10,y):(u=v,v-=1/Math.pow(10,y));v=Number(v.toFixed(y));u=Number(u.toFixed(y));return[v,u]},getPctChange:function(u,
y,v,W){var N={prev:null,next:null};if(null!=v){var T=u-v;N.prev=Math.floor(Math.abs(100*(y-v-T)/T))}null!=W&&(T=W-u,N.next=Math.floor(Math.abs(100*(W-y-T)/T)));return N},round:function(u,y){u=u.slice(0);var v,W,N=y&&null!=y.tolerance?y.tolerance:2,T=y&&y.indexes,ia=y&&null!=y.strictBounds?y.strictBounds:!1;if(T)T.sort(G);else for(T=[],v=0;v<u.length;v++)T.push(v);for(v=0;v<T.length;v++){var E=T[v];y=u[E];var k=0===E?null:u[E-1];var I=E===u.length-1?null:u[E+1];var q=S.getDigits(y);if(q=q.fractional){var n=
0;for(W=!1;n<=q&&!W;){var z=S.getFixedNumbers(y,n);z=ia&&0===v?z[1]:z[0];W=S.hasMinimalChange(y,z,k,I,N);n++}W&&(u[E]=z)}}return u},hasMinimalChange:function(u,y,v,W,N){u=S.getPctChange(u,y,v,W);y=null==u.prev||u.prev<=N;v=null==u.next||u.next<=N;return y&&v||u.prev+u.next<=2*N},_reAllZeros:new RegExp("\\"+A.decimal+"0+$","g"),_reSomeZeros:/(\d)0*$/g,format:function(u,y){y=y||{places:20,round:-1};(u=R.format(u,y))&&(u=u.replace(S._reSomeZeros,"$1").replace(S._reAllZeros,""));return u}};M("extend-esri")&&
(r.numberUtils=S);return S})},"esri/renderers/utils":function(){define("dojo/_base/lang dojo/_base/array dojo/has dojo/date/locale ../kernel ../numberUtils ../Color dojo/i18n!dojo/cldr/nls/gregorian".split(" "),function(M,R,A,r,G,S,u,y){function v(q){return q&&R.map(q,function(n){return new u(n)})}function W(q,n,z){var C="";0===n?C=T.lt+" ":n===z&&(C=T.gt+" ");return C+q}var N={},T={lte:"\x3c\x3d",gte:"\x3e\x3d",lt:"\x3c",gt:"\x3e",pct:"%"},ia={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,
year:6},E={millisecond:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},second:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},minute:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},hour:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},day:{selector:"date",dateOptions:{formatLength:"long"}},month:{selector:"date",dateOptions:{formatLength:"long"}},year:{selector:"date",dateOptions:{selector:"year"}}},k={formatLength:"short",
fullYear:!0},I={formatLength:"short"};M.mixin(N,{timelineDateFormatOptions:{selector:"date",dateOptions:{formatLength:"short",fullYear:!0}},formatDate:function(q,n){var z=[];null==q||q instanceof Date||(q=new Date(q));n=n||{};n=M.mixin({},n);var C=n.selector?n.selector.toLowerCase():null,B=!C||-1<C.indexOf("time");C=!C||-1<C.indexOf("date");B&&(n.timeOptions=n.timeOptions||I,n.timeOptions&&(n.timeOptions=M.mixin({},n.timeOptions),n.timeOptions.selector=n.timeOptions.selector||"time",z.push(n.timeOptions)));
C&&(n.dateOptions=n.dateOptions||k,n.dateOptions&&(n.dateOptions=M.mixin({},n.dateOptions),n.dateOptions.selector=n.dateOptions.selector||"date",z.push(n.dateOptions)));z&&z.length?(z=R.map(z,function(F){return r.format(q,F)}),n=1==z.length?z[0]:y["dateTimeFormat-medium"].replace(/'/g,"").replace(/\{(\d+)\}/g,function(F,J){return z[J]})):n=r.format(q);return n},createColorStops:function(q){var n=q.values,z=q.colors,C=q.labelIndexes,B=q.isDate,F=q.dateFormatOptions;q=[];return q=R.map(n,function(J,
U){var O=null;if(!C||-1<R.indexOf(C,U)){var K;(K=B?N.formatDate(J,F):S.format(J))&&(O=W(K,U,n.length-1))}return{value:J,color:z[U],label:O}})},updateColorStops:function(q){var n=q.stops,z=q.changes,C=q.isDate,B=q.dateFormatOptions,F=[],J=R.map(n,function(O){return O.value});R.forEach(z,function(O){F.push(O.index);J[O.index]=O.value});var U=S.round(J,{indexes:F});R.forEach(n,function(O,K){O.value=J[K];if(null!=O.label){var Y,ka=null;(Y=C?N.formatDate(U[K],B):S.format(U[K]))&&(ka=W(Y,K,n.length-1));
O.label=ka}})},createClassBreakLabel:function(q){var n=q.minValue,z=q.maxValue,C=q.isFirstBreak?"":T.gt+" ";q="percent-of-total"===q.normalizationType?T.pct:"";n=null==n?"":S.format(n);z=null==z?"":S.format(z);return C+n+q+" \u2013 "+z+q},setLabelsForClassBreaks:function(q){var n=q.classBreaks,z=q.classificationMethod,C=q.normalizationType,B=[];n&&n.length&&("standard-deviation"===z?console.log("setLabelsForClassBreaks: cannot set labels for class breaks generated using 'standard-deviation' method."):
q.round?(B.push(n[0].minValue),R.forEach(n,function(F){B.push(F.maxValue)}),B=S.round(B),R.forEach(n,function(F,J){F.label=N.createClassBreakLabel({minValue:0===J?B[0]:B[J],maxValue:B[J+1],isFirstBreak:0===J,normalizationType:C})})):R.forEach(n,function(F,J){F.label=N.createClassBreakLabel({minValue:F.minValue,maxValue:F.maxValue,isFirstBreak:0===J,normalizationType:C})}))},updateClassBreak:function(q){var n=q.classBreaks,z=q.normalizationType,C=q.change,B=C.index;C=C.value;var F=-1,J=-1,U=n.length;
"standard-deviation"===q.classificationMethod?console.log("updateClassBreak: cannot update labels for class breaks generated using 'standard-deviation' method."):(0===B?F=B:B===U?J=B-1:(J=B-1,F=B),-1<F&&F<U&&(q=n[F],q.minValue=C,q.label=N.createClassBreakLabel({minValue:q.minValue,maxValue:q.maxValue,isFirstBreak:0===F,normalizationType:z})),-1<J&&J<U&&(q=n[J],q.maxValue=C,q.label=N.createClassBreakLabel({minValue:q.minValue,maxValue:q.maxValue,isFirstBreak:0===J,normalizationType:z})))},calculateDateFormatInterval:function(q){var n,
z,C=q.length,B=Infinity;q=R.map(q,function(ua){return new Date(ua)});for(n=0;n<C-1;n++){var F=q[n];var J=[];var U=Infinity;var O="";for(z=n+1;z<C;z++){var K=q[z];K=F.getFullYear()!==K.getFullYear()&&"year"||F.getMonth()!==K.getMonth()&&"month"||F.getDate()!==K.getDate()&&"day"||F.getHours()!==K.getHours()&&"hour"||F.getMinutes()!==K.getMinutes()&&"minute"||F.getSeconds()!==K.getSeconds()&&"second"||"millisecond";var Y=ia[K];Y<U&&(U=Y,O=K);J.push(K)}if(U<B){B=U;var ka=O}}return ka},createUniqueValueLabel:function(q){var n=
q.value,z=q.fieldInfo,C=q.domain;q=q.dateFormatInterval;var B=String(n);(C=C&&C.codedValues?C.getName(n):null)?B=C:"number"===typeof n&&(B=z&&"esriFieldTypeDate"===z.type?N.formatDate(n,q&&E[q]):S.format(n));return B},cloneColorInfo:function(q){if(q){var n=M.mixin({},q);n.colors=v(n.colors);n.stops=n.stops&&R.map(n.stops,function(z){z=M.mixin({},z);z.color&&(z.color=new u(z.color));return z});n.legendOptions&&(n.legendOptions=M.mixin({},n.legendOptions))}return n},cloneOpacityInfo:function(q){if(q){var n=
M.mixin({},q);if(q=n.opacityValues)n.opacityValues=q.slice(0);if(q=n.stops)n.stops=R.map(q,function(z){return M.mixin({},z)});if(q=n.legendOptions)n.legendOptions=M.mixin({},q)}return n},cloneSizeInfo:function(q){if(q){var n=M.mixin({},q);n.stops&&(n.stops=R.map(n.stops,function(z){return M.mixin({},z)}));(q=n.minSize)&&"object"===typeof q&&(n.minSize=N.cloneSizeInfo(q));(q=n.maxSize)&&"object"===typeof q&&(n.maxSize=N.cloneSizeInfo(q));if(q=n.legendOptions)if(n.legendOptions=M.mixin({},q),q=q.customValues)n.legendOptions.customValues=
q.slice(0)}return n},getClassCodesForRelationship:function(){return M.clone({2:["L","H"],3:["L","M","H"],4:["L","M1","M2","H"]})},getClassValuesForRelationship:function(){return M.clone({2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]})}});A("extend-esri")&&M.setObject("renderer.utils",N,G);return N})},"*noref":1}});
define("esri/dijit/Legend","dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/json dojo/_base/Color dojo/debounce dojo/has dojo/sniff dojo/Deferred dojo/DeferredList dojo/json dojo/dom dojo/dom-construct dojo/dom-style dojo/dom-class dijit/_Widget dojox/gfx dojox/gfx/matrix dojox/html/entities ../kernel ../config ../request ../lang ../numberUtils ../renderers/utils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/ClassBreaksRenderer ../renderers/ScaleDependentRenderer ../renderers/DotDensityRenderer ../renderers/TemporalRenderer ../renderers/VectorFieldRenderer ../renderers/HeatmapRenderer ../symbols/PictureFillSymbol ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ../symbols/utils ../symbols/jsonUtils ../renderers/jsonUtils ./_EventedWidget dojo/i18n!../nls/jsapi".split(" "),function(M,
R,A,r,G,S,u,y,v,W,N,T,ia,E,k,I,q,n,z,C,B,F,J,U,O,K,Y,ka,ua,Ka,La,Ma,Na,va,Oa,Ba,pa,ra,wa,Ca,qa,Da,Ea,xa){var Fa=Y.getClassValuesForRelationship(),Ga={defaultShape:{type:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15"},stroke:{width:1,color:"#555555"}},ya={HH:315,HL:45,LL:135,LH:225},Ha=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,ea=R([Ea,n],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:!1,layers:null,alignRight:!1,hoverLabelShowing:!1,dotDensitySwatchSize:26,dotCoverage:75,gradientHeight:30,transparencyRampColor:new u([64,
64,64]),defaultText:"Aa",sizeRampLightColor:new u([255,255,255]),sizeRampDarkColor:new u([128,128,128]),gradientWidth:34,colorRampBorder:"1px solid",_specialChars:{lt:"\x3c",gt:"\x3e"},_ieTimer:100,_isRightToLeft:!1,_align:null,_legendAlign:null,_preserveCacheOnDestroy:!1,_layerConnects:null,_mapConnects:null,constructor:function(a,b){A.mixin(this,xa.widgets.legend);this._i18n=xa.widgets.legend;a=a||{};a.map?b?(this.map=a.map,this.layerInfos=a.layerInfos,this._respectCurrentMapScale=!1===a.respectCurrentMapScale?
!1:!0,this._respectVisibility=!1===a.respectVisibility?!1:!0,this._preserveCacheOnDestroy=a.preserveCacheOnDestroy?!0:!1,this.arrangement=a.arrangement===ea.ALIGN_RIGHT?ea.ALIGN_RIGHT:ea.ALIGN_LEFT,this.arrangement===ea.ALIGN_RIGHT&&(this.alignRight=!0),this.autoUpdate=!1===a.autoUpdate?!1:!0,this._surfaceItems=[],this.hideLayersInLegend={},this.refresh=y(this.refresh,0)):console.error("esri.dijit.Legend: must specify a container for the legend"):console.error("esri.dijit.Legend: unable to find the 'map' property in parameters")},
postMixInProperties:function(){this.inherited(arguments);var a=["ar","he"],b;for(b=0;b<a.length;b+=1){var c=a[b];M.locale&&-1!==M.locale.indexOf(c)&&(-1!==M.locale.indexOf("-")?-1!==M.locale.indexOf(c+"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0)}this._isRightToLeft?(this._align=this.alignRight?"left":"right",this._legendAlign=this.alignRight?"esriLegendLeft":"esriLegendRight"):(this._align=this.alignRight?"right":"left",this._legendAlign=this.alignRight?"esriLegendRight":"esriLegendLeft")},
startup:function(){this.inherited(arguments);this._initialize();9>v("ie")&&(this._repaintItems=A.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this._deactivate();this._removeCachedLegendResponses();this._removeHoverHandlers();this.inherited(arguments)},_removeCachedLegendResponses:function(){this._preserveCacheOnDestroy||r.forEach(this.layers,function(a){delete a.legendResponse})},refresh:function(a){if(this.domNode){a?(this.layerInfos=a,this.layers=
[],r.forEach(this.layerInfos,function(b){this._isSupportedLayerType(b.layer)&&(b.title&&(b.layer._titleForLegend=b.title),b.layer._hideDefaultSymbol=!1===b.defaultSymbol?!0:!1,b.hideLayers?(this.hideLayersInLegend[b.layer.id]=b.hideLayers,this._addSubLayersToHide(b)):this.hideLayersInLegend[b.layer.id]=[],b.hoverLabel&&(b.layer._hoverLabel=b.hoverLabel),b.hoverLabels&&(b.layer._hoverLabels=b.hoverLabels),this.layers.push(b.layer))},this)):this.useAllMapLayers&&(this.layers=this.layerInfos=null);for(a=
this.domNode.children.length-1;0<=a;a--)k.destroy(this.domNode.children[a]);this._removeHoverHandlers();this.startup()}},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){this.layerInfos&&(this.layers=[],r.forEach(this.layerInfos,function(c){this._isSupportedLayerType(c.layer)&&(c.title&&(c.layer._titleForLegend=c.title),c.layer._hideDefaultSymbol=!1===c.defaultSymbol?!0:!1,c.hideLayers?(this.hideLayersInLegend[c.layer.id]=c.hideLayers,this._addSubLayersToHide(c)):
this.hideLayersInLegend[c.layer.id]=[],c.hoverLabel&&(c.layer._hoverLabel=c.hoverLabel),c.hoverLabels&&(c.layer._hoverLabels=c.hoverLabels),this.layers.push(c.layer))},this));this.useAllMapLayers=!1;if(!this.layers){this.useAllMapLayers=!0;this.layers=[];var a=[],b=[];r.forEach(this.map.layerIds,function(c){c=this.map.getLayer(c);this._isSupportedLayerType(c)&&(c.arcgisProps&&c.arcgisProps.title&&(c._titleForLegend=c.arcgisProps.title),this.layers.push(c));if("esri.layers.KMLLayer"==c.declaredClass){var e=
c.getLayers();r.forEach(e,function(d){a.push(d.id)},this)}"esri.layers.GeoRSSLayer"==c.declaredClass&&(e=c.getFeatureLayers(),r.forEach(e,function(d){b.push(d.id)},this))},this);r.forEach(this.map.graphicsLayerIds,function(c){var e=this.map.getLayer(c);-1==r.indexOf(a,c)&&-1==r.indexOf(b,c)&&this._isSupportedLayerType(e)&&this._isLayerDrawingEnabled(e)&&(e.arcgisProps&&e.arcgisProps.title&&(e._titleForLegend=e.arcgisProps.title),this.layers.push(e))},this)}this._createLegend()},_isLayerDrawingEnabled:function(a){return a&&
(a._params&&a._params.drawMode||a.isFeatureReductionActive&&a.isFeatureReductionActive())},_activate:function(){this._deactivate();if(this.autoUpdate){this._mapConnects=[];this._layerConnects={};var a=this._mapConnects;this._respectCurrentMapScale&&a.push(G.connect(this.map,"onZoomEnd",this,"_refreshLayers"));this.useAllMapLayers&&(a.push(G.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers")),a.push(G.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers")),a.push(G.connect(this.map,"onLayersReordered",
this,"_updateAllMapLayers")));r.forEach(this.layers,function(b){var c=[G.connect(b,"onFeatureReductionRendererChange",this,"_refreshLayers"),G.connect(b,"onFeatureReductionChange",this,"_refreshLayers"),G.connect(b,"onVisibilityChange",this,"_refreshLayers"),G.connect(b,"onOpacityChange",this,"_refreshLayers"),G.connect(b,"onScaleRangeChange",this,"_refreshLayers")];"esri.layers.ArcGISDynamicMapServiceLayer"===b.declaredClass&&b.supportsDynamicLayers&&c.push(G.connect(b,"_onDynamicLayersChange",A.hitch(this,
"_updateDynamicLayers",b)));if("esri.layers.ArcGISImageServiceLayer"===b.declaredClass||"esri.layers.RasterXLayer"===b.declaredClass)c.push(G.connect(b,"onRenderingChange",A.partial(this._updateImageServiceLayers,this,b))),c.push(G.connect(b,"onRendererChange",A.partial(this._updateImageServiceLayers,this,b)));("esri.layers.ArcGISImageServiceVectorLayer"===b.declaredClass||b.setWebGLEnabled)&&c.push(G.connect(b,"onRendererChange",A.hitch(this,"_refreshLayers")));this._layerConnects[b.id]=c},this)}},
_deactivate:function(){r.forEach(this._mapConnects,function(a){G.disconnect(a)});r.forEach(this.layers,function(a){var b=this._layerConnects;b&&r.forEach(b[a.id],function(c){G.disconnect(c)})},this);this._mapConnects=this._layerConnects=null},_updateDynamicLayers:function(a){delete a.legendResponse;this._refreshLayers()},_updateImageServiceLayers:function(a,b){delete b.legendResponse;a._refreshLayers()},_refreshLayers:function(){this.refresh()},_updateAllMapLayers:function(){this.layers=[];r.forEach(this.map.layerIds,
function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&this.layers.push(a)},this);r.forEach(this.map.graphicsLayerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&this._isLayerDrawingEnabled(a)&&this.layers.push(a)},this);this.refresh()},_createLegend:function(){var a=!1,b=!1;I.set(this.domNode,"position","relative");k.create("div",{id:this.id+"_msg",className:"esriLegendMsg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var c=[];r.forEach(this.layers,function(d){if("esri.layers.KMLLayer"==
d.declaredClass||"esri.layers.GeoRSSLayer"==d.declaredClass)if(d.loaded){if("esri.layers.KMLLayer"==d.declaredClass)var f=d.getLayers();else"esri.layers.GeoRSSLayer"==d.declaredClass&&(f=d.getFeatureLayers(),this.hideLayersInLegend[d.id]&&(f=r.filter(f,function(g){return-1==r.indexOf(this.hideLayersInLegend[d.id],g.id)},this)));r.forEach(f,function(g){"esri.layers.FeatureLayer"==g.declaredClass&&d._titleForLegend&&(g._titleForLegend=d._titleForLegend+" - ","esriGeometryPoint"==g.geometryType?g._titleForLegend+=
this.NLS_points:"esriGeometryPolyline"==g.geometryType?g._titleForLegend+=this.NLS_lines:"esriGeometryPolygon"==g.geometryType&&(g._titleForLegend+=this.NLS_areas),c.push(g))},this)}else G.connect(d,"onLoad",A.hitch(this,function(){this.refresh(this.layerInfos)}));else if("esri.layers.WMSLayer"===d.declaredClass)if(!d.loaded)G.connect(d,"onLoad",A.hitch(this,function(){this.refresh(this.layerInfos)}));else{if((!this._respectVisibility||this._respectVisibility&&d.visible)&&0<d.layerInfos.length&&r.some(d.layerInfos,
function(g){return g.legendURL})){var h=!1;r.forEach(d.layerInfos,function(g){if(g.legendURL&&-1<r.indexOf(d.visibleLayers,g.name)){h||(k.create("div",{innerHTML:"\x3cspan class\x3d'esriLegendServiceLabel'\x3e"+(d._titleForLegend||d.name||d.id)+"\x3c/span\x3e"},this.domNode),h=!0);var p;g=g.legendURL;if(d.customParameters||d.customLayerParameters){var m=A.clone(d.customParameters||{});A.mixin(m,d.customLayerParameters||{});for(p in m)g+=(-1===g.indexOf("?")?"?":"\x26")+p+"\x3d"+m[p]}k.create("div",
{innerHTML:"\x3cimg src\x3d'"+g+"'/\x3e"},this.domNode);a=!0}},this)}}else"esri.layers.WFSLayer"!==d.declaredClass||d.renderer?c.push(d):(f=k.create("div",{id:this.id+"_"+d.id,"class":"esriLegendService"}),k.create("span",{innerHTML:this._getServiceTitle(d),"class":"esriLegendServiceLabel"},k.create("td",{align:this._align},k.create("tr",{},k.create("tbody",{},k.create("table",{width:"95%"},f))))),k.place(f,this.id,"first"),f=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},
f),f=k.create("tbody",{},f),"esriGeometryComplex"===d.geometryType?(this._buildRow_Renderer(d,d._pointSymbol,null,this.NLS_points,null,f),this._buildRow_Renderer(d,d._lineSymbol,null,this.NLS_lines,null,f),this._buildRow_Renderer(d,d._polygonSymbol,null,this.NLS_areas,null,f)):"esriGeometryPoint"===d.geometryType?this._buildRow_Renderer(d,d._pointSymbol,null,"",null,f):"esriGeometryPolyline"===d.geometryType?this._buildRow_Renderer(d,d._lineSymbol,null,"",null,f):"esriGeometryPolygon"===d.geometryType&&
this._buildRow_Renderer(d,d._polygonSymbol,null,"",null,f),b=!0)},this);var e=[];r.forEach(c,function(d){if(!d.loaded)var f=G.connect(d,"onLoad",this,function(g){G.disconnect(f);f=null;this.refresh()});else if((!this._respectVisibility||this._respectVisibility&&d.visible)&&(d.layerInfos||d.renderer||"esri.layers.ArcGISImageServiceLayer"==d.declaredClass||"esri.layers.RasterXLayer"==d.declaredClass)){var h=k.create("div",{id:this.id+"_"+d.id,style:{display:"none"},"class":"esriLegendService"});k.create("span",
{innerHTML:this._getServiceTitle(d),"class":"esriLegendServiceLabel"},k.create("td",{align:this._align},k.create("tr",{},k.create("tbody",{},k.create("table",{width:"95%"},h)))));k.place(h,this.id,"first");d.legendResponse||d.renderer&&"esri.renderer.StretchRenderer"!==d.renderer.declaredClass||d.renderer&&"esri.renderer.StretchRenderer"===d.renderer.declaredClass&&1===d.bandCount?this._createLegendForLayer(d):this.isHostedTileService(d)?this._getLayerInfos(d).then(A.hitch(this,function(g){this._createLegendForLayer(g)}),
A.hitch(this,function(g){e.push(this._legendRequest(g))})):"esri.layers.RasterXLayer"===d.declaredClass&&-1<d.capabilities.toLowerCase().indexOf("tilesonly")?this._createLegendForTileOnlyService(d):e.push(this._legendRequest(d))}},this);0!==e.length||a||b?(new T(e)).addCallback(A.hitch(this,function(d){a||b?E.byId(this.id+"_msg").innerHTML="":E.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate()})):(E.byId(this.id+"_msg").innerHTML=this.NLS_noLegend,this._activate())},_createLegendForTileOnlyService:function(a){function b(m,
t){var l=["red","green","blue"],x=[[255,0,0],[0,255,0],[0,0,255]];(t&&t.length>=f?c(t):c()).forEach(function(H,w){var D=new pa(pa.STYLE_SQUARE,20,new ra(ra.STYLE_SOLID,new u([0,0,0]),1),new u(x[w]));m._buildRow_Renderer(a,D,null,l[w]+": "+H,null,d)},m)}function c(m){var t=(a.bandIds&&a.bandIds.length?a.bandIds:[0,1,2]).map(function(l){return m&&m[l]&&m[l].BandName||"Band_"+(l+1)});3>t.length?t.push(t[1]):3<t.length&&t.splice(3);return t}var e=k.create("div",{id:this.id+"_"+a.id+"_clientLegend","class":"esriLegendServiceLabel"},
E.byId(this.id+"_"+a.id));k.create("td",{align:this._align},k.create("tr",{},k.create("tbody",{},k.create("table",{width:"95%","class":"esriLegendLayerLabel"},e))));e=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e);var d=k.create("tbody",{},e),f=a.bandCount;if(1<f)a.getKeyProperties().then(A.hitch(this,function(m){b(this,m.BandProperties)}),A.hitch(this,function(m){b(this)})),I.set(E.byId(this.id+"_"+a.id),"display","block"),I.set(E.byId(this.id+"_msg"),"display",
"none");else{e={colorRamp:{type:"algorithmic",fromColor:[0,0,0],toColor:[255,255,255]}};var h=a.renderer;if(h&&h.statistics&&h.statistics.length){var g=null!=h.statistics[0].min?h.statistics[0].min:h.statistics[0][0];var p=null!=h.statistics[0].max?h.statistics[0].max:h.statistics[0][1]}else g=a.serviceInfo.minValues.length?a.serviceInfo.minValues[0]:0,p=a.serviceInfo.maxValues.length?a.serviceInfo.maxValues[0]:255;this._createStretchLegend(d,h||e,g,p)}},_createLegendForLayer:function(a){if(a.legendResponse||
a.renderer||this.isHostedTileService(a)){var b=!1;if(a.legendResponse||this.isHostedTileService(a)){var c=a.dynamicLayerInfos||a.layerInfos;if(c&&c.length)r.forEach(c,function(e,d){this.hideLayersInLegend[a.id]&&-1!==r.indexOf(this.hideLayersInLegend[a.id],e.id)||(e=this._buildLegendItems(a,e,d),b=b||e)},this);else if("esri.layers.ArcGISImageServiceLayer"==a.declaredClass||"esri.layers.RasterXLayer"==a.declaredClass)b=this._buildLegendItems(a,{id:0,name:null,title:a.name,subLayerIds:null,parentLayerId:-1},
0)}else a.renderer&&(c=a.url?a.url.substring(a.url.lastIndexOf("/")+1,a.url.length):"fc_"+a.id,b=this._buildLegendItems(a,{id:c,name:null,subLayerIds:null,parentLayerId:-1},0));b&&(I.set(E.byId(this.id+"_"+a.id),"display","block"),I.set(E.byId(this.id+"_msg"),"display","none"))}},_legendRequest:function(a){if(a.loaded)return 10.01<=a.version?this._legendRequestServer(a):this._legendRequestTools(a);G.connect(a,"onLoad",A.hitch(this,"_legendRequest"))},_legendRequestServer:function(a){var b=a.url,c=
b.indexOf("?");b=-1<c?b.substring(0,c)+"/legend"+b.substring(c):b+"/legend";(c=a._getToken())&&(b+="?token\x3d"+c);var e=A.hitch(this,"_processLegendResponse"),d={f:"json"};a._params.dynamicLayers&&(d.dynamicLayers=ia.stringify(this._createDynamicLayers(a)),"[{}]"===d.dynamicLayers&&(d.dynamicLayers="[]"));a._params.bandIds&&(d.bandIds=a._params.bandIds);a._params.renderingRule?d.renderingRule=a._params.renderingRule:a.rasterFunctionInfos&&0<a.rasterFunctionInfos.length&&r.forEach(a.rasterFunctionInfos,
function(f){f&&f.name&&"none"===f.name.toLowerCase()&&(d.renderingRule=ia.stringify({rasterFunction:f.name}))});(c=a._params.mosaicRule&&JSON.parse(a._params.mosaicRule))&&c.multidimensionalDefinition&&c.multidimensionalDefinition.length&&(d.variable=c.multidimensionalDefinition[0].variableName);return U({url:b,content:d,callbackParamName:"callback",load:function(f,h){e(a,f,h)},error:J.defaults.io.errorHandler})},_legendRequestTools:function(a){var b=a.url.toLowerCase().indexOf("/rest/");b=a.url.substring(0,
b)+a.url.substring(b+5,a.url.length);b=this._legendUrl+"?soapUrl\x3d"+window.escape(b);if(!v("ie")||8<v("ie"))b+="\x26returnbytes\x3dtrue";var c=A.hitch(this,"_processLegendResponse");return U({url:b,content:{f:"json"},callbackParamName:"callback",load:function(e,d){c(a,e,d)},error:J.defaults.io.errorHandler})},_processLegendResponse:function(a,b){b&&b.layers?(a.legendResponse=b,E.byId(this.id+"_"+a.id)&&k.empty(E.byId(this.id+"_"+a.id)),k.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},
k.create("td",{align:this._align},k.create("tr",{},k.create("tbody",{},k.create("table",{width:"95%"},E.byId(this.id+"_"+a.id)))))),this._createLegendForLayer(a)):console.log("Legend could not get generated for "+a.url+": "+S.toJson(b))},_buildLegendItems:function(a,b,c){var e=!1,d=E.byId(this.id+"_"+a.id),f=b.parentLayerId;if(b.subLayerIds)a=k.create("div",{id:this.id+"_"+a.id+"_"+b.id+"_group",style:{display:"none"},"class":-1==f?0<c?"esriLegendGroupLayer":"":this._legendAlign},-1==f?d:E.byId(this.id+
"_"+a.id+"_"+f+"_group")),k.create("td",{innerHTML:B.encode(b.name),align:this._align},k.create("tr",{},k.create("tbody",{},k.create("table",{width:"95%","class":"esriLegendLayerLabel"},a))));else{if(this._respectVisibility&&a.visibleLayers)if(c=a.dynamicLayerInfos||a.layerInfos)if(a._params&&a._params.layers){if(-1===r.indexOf(a.visibleLayers,b.id))return e}else{if(c=this._getReallyVisibleLayers(c,a.visibleLayers),-1===r.indexOf(c,b.id))return e}else if(-1===r.indexOf(a.visibleLayers,b.id))return e;
d=k.create("div",{id:this.id+"_"+a.id+"_"+b.id,style:{display:"none"},"class":-1<f?this._legendAlign:""},-1==f?d:E.byId(this.id+"_"+a.id+"_"+f+"_group"));k.create("td",{innerHTML:B.encode(b.name)||"",align:this._align},k.create("tr",{},k.create("tbody",{},k.create("table",{width:"95%","class":"esriLegendLayerLabel"},d))));c=a.dynamicLayerInfos||a.layerInfos;f=!1;c&&c.length&&(f=r.some(c,function(h){return!!h.drawingInfo}));if(a.legendResponse)e=e||this._buildLegendItems_Tools(a,b,d);else if(a.renderer||
f)e=e||this._buildLegendItems_Renderer(a,b,d)}return e},_getReallyVisibleLayers:function(a,b){if(!a||!b||!b.length)return[];var c=[],e=[],d;for(d=0;d<a.length;d++)if(a[d].subLayerIds){if(-1===r.indexOf(b,a[d].id)||-1<r.indexOf(e,a[d].id))e=e.concat(a[d].subLayerIds)}else-1<r.indexOf(b,a[d].id)&&-1===r.indexOf(e,a[d].id)&&c.push(a[d].id);return c},_buildLegendItems_Tools:function(a,b,c){var e=b.parentLayerId,d=this.map.getScale(),f=!1,h=function(w,D){var P,X;for(P=0;P<w.length;P++)if(D.dynamicLayerInfos)for(X=
0;X<D.dynamicLayerInfos[X].length;X++){if(D.dynamicLayerInfos[X].mapLayerId==w[P].layerId)return w[P]}else if(D.id==w[P].layerId)return w[P];return{}};if(!this._respectCurrentMapScale||this._respectCurrentMapScale&&this._isLayerInScale(a,b,d)){var g=!0;if(this._respectCurrentMapScale&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISMapServiceLayer"===a.declaredClass)){var p=this._getEffectiveScale(a,b);if(p.minScale&&p.minScale<d||p.maxScale&&p.maxScale>d)g=!1}if(g){d=
h(a.legendResponse.layers,b);var m=d.legendType,t=d.layerType,l=d.legend;if(l){"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&"esri.layers.RasterXLayer"===a.declaredClass||this._sanitizeLegendResponse(a,d,b);c=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);var x=k.create("tbody",{},c);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(c,a,b);var H=[];r.forEach(l,function(w){if(!(10.1<=a.version&&!w.values&&1<l.length)||!a._hideDefaultSymbol&&
"\x3call other values\x3e"!==w.label&&(w.label||"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.3<=a.version||"Raster Layer"===t)){var D=w.label;if(w.url&&0===w.url.indexOf("http")||w.imageData&&0<w.imageData.length)f=!0,D&&-1!==r.indexOf(H,D)||(H.push(D),this._buildRow_Tools(w,x,a,b.id,m))}},this)}}}f&&(I.set(E.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<e&&(I.set(E.byId(this.id+"_"+a.id+"_"+e+"_group"),"display","block"),this._findParentGroup(a.id,a,e)));return f},_getLayerInfos:function(a){var b=
new N,c=a.dynamicLayerInfos||a.layerInfos;if(c&&c.length)if(r.some(c,function(f){return!!f.drawingInfo}))b.resolve(a);else{var e=a.url,d=e.indexOf("?");e=-1==d?e+"/layers":e.substring(0,d)+"/layers"+e.substring(d,e.length);U({url:e,content:{f:"json"},callbackParamName:"callback",load:function(f,h){f.layers?(r.forEach(c,function(g){var p=r.filter(f.layers,function(m){return g.source?m.id===g.source.mapLayerId:m.id===g.id});p&&p[0]&&p[0].drawingInfo&&(g.drawingInfo=p[0].drawingInfo,g.fields=p[0].fields)}),
b.resolve(a)):b.reject(a)},error:function(f){b.reject(a)}})}return b},_sanitizeLegendResponse:function(a,b,c){var e=b.legend;if(10.1<=a.version&&1<e.length&&!b._sanitized){a=A.getObject("layerDefinition.drawingInfo.renderer",!1,c);var d,f;a||(a=A.getObject("drawingInfo.renderer",!1,c));r.some(e,function(h){if(h.values)return!0})&&r.some(e,function(h,g){h.values||(f=g,d=h);return!!d});a?"uniqueValue"===a.type?d&&(e.splice(f,1),e.push(d)):"classBreaks"===a.type&&(d&&e.splice(f,1),e.reverse(),d&&e.push(d)):
d&&(e.splice(f,1),e.push(d));b._sanitized=!0}},_buildRow_Tools:function(a,b,c,e,d){var f=k.create("tr",{},b);if(this.alignRight){b=k.create("td",{align:this._isRightToLeft?"left":"right"},f);var h=k.create("td",{align:this._isRightToLeft?"left":"right",width:35},f)}else h=k.create("td",{width:35,align:"center"},f),b=k.create("td",{},f);f=a.url;(!v("ie")||9<=v("ie")||9>v("ie")&&("esri.layers.ArcGISImageServiceLayer"===c.declaredClass||"esri.layers.RasterXLayer"===c.declaredClass))&&a.imageData&&0<
a.imageData.length?f="data:image/png;base64,"+a.imageData:0!==a.url.indexOf("http")&&(f=c.url+"/"+e+"/images/"+a.url,(e=c._getToken())&&(f+="?token\x3d"+e));e=k.create("img",{src:f,border:0,style:"opacity:"+c.opacity},h);a=k.create("td",{innerHTML:B.encode(a.label),align:this._align},k.create("tr",{},k.create("tbody",{},k.create("table",{width:"95%",dir:"ltr"},b))));d&&"Stretched"===d&&10.3<=c.version&&("esri.layers.ArcGISImageServiceLayer"===c.declaredClass||"esri.layers.RasterXLayer"===c.declaredClass)&&
(a.style.verticalAlign="top",a.style.lineHeight="1",e.style.marginBottom="-1px",e.style.display="block",b.style.verticalAlign="top");9>v("ie")&&(e.style.filter="alpha(opacity\x3d"+100*c.opacity+")")},_getVariable:function(a,b,c){if(a)var e=(a=a.getVisualVariablesForType(b,c))&&a[0];return e},_getVariables:function(a,b,c){a=[this._getVariable(a,"colorInfo",!1),this._getVariable(a,"opacityInfo",!1),this._getVariable(a,"sizeInfo",!1)];return b?r.filter(a,function(e){return!(!e||e.field!==b||e.normalizationField!=
c)}):a},_getFieldAlias:function(a,b,c){var e=b.infoTemplate||(b.infoTemplates&&c&&b.infoTemplates[c.id]?b.infoTemplates[c.id].infoTemplate:null);e=e&&e.getFieldInfo&&e.getFieldInfo(a);a=A.isFunction(a)?null:this.getField(b,a,c);b=e||a;c="";b&&(c=e&&e.label||a&&a.alias||b.name||b.fieldName);return c},_getDomainName:function(a,b,c,e){if(a&&!A.isFunction(a))var d=(c=(a=this.getField(c,a,e))&&c.getDomain?c.getDomain(a.name):null)&&c.codedValues?c.getName(b):null;return d},_getRampTitle:function(a,b,c){var e=
a.field,d=a.normalizationField,f=!1,h=!1,g=!1;e=A.isFunction(e)?null:e;d=A.isFunction(d)?null:d;if(a.legendOptions&&a.legendOptions.title)var p=a.legendOptions.title;else if(a.valueExpressionTitle)p=a.valueExpressionTitle;else{if(b.renderer&&b.renderer.authoringInfo&&b.renderer.authoringInfo.visualVariables){var m=b.renderer.authoringInfo.visualVariables;for(a=0;a<m.length;a++){var t=m[a];if("colorInfo"===t.type&&"ratio"===t.style){f=!0;break}else if("colorInfo"===t.type&&"percent"===t.style){h=!0;
break}else if("colorInfo"===t.type&&"percentTotal"===t.style){g=!0;break}}}(f=g&&"showRatioPercentTotal"||h&&"showRatioPercent"||f&&"showRatio"||d&&"showNormField"||e&&"showField"||null)&&(p=O.substitute({field:e&&this._getFieldAlias(e,b,c),normField:d&&this._getFieldAlias(d,b,c)},"showField"===f?"${field}":this._i18n[f]))}return p},_getRendererTitle:function(a,b,c){if(a){if("esri.renderer.ClassBreaksRenderer"===a.declaredClass){var e=a.attributeField;var d=a.normalizationField;var f="percent-of-total"===
a.normalizationType}e=A.isFunction(e)?null:e;d=A.isFunction(d)?null:d;if(a.legendOptions&&a.legendOptions.title)var h=a.legendOptions.title;else a.valueExpressionTitle?h=a.valueExpressionTitle:(a=d&&"showNormField"||(f?"showNormPct":null)||e&&"showField"||null)&&(h=O.substitute({field:e&&this._getFieldAlias(e,b,c),normField:d&&this._getFieldAlias(d,b,c)},"showField"===a?"${field}":this._i18n[a]))}return h},_buildLegendItems_Renderer:function(a,b,c){function e(){I.set(E.byId(ja.id+"_"+a.id+"_"+b.id),
"display","block");-1<d&&(I.set(E.byId(ja.id+"_"+a.id+"_"+d+"_group"),"display","block"),this._findParentGroup(a.id,d))}var d=b.parentLayerId,f=this.map,h=f.getScale(),g=!1;if(!this._respectCurrentMapScale||this._isLayerInScale(a,b,h)){var p,m,t;var l="esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass?a.renderer.renderer:b&&b.drawingInfo?Da.fromJson(A.clone(b.drawingInfo.renderer)):a.isFeatureReductionActive&&a.isFeatureReductionActive()?a.getFeatureReductionRenderer():a.renderer;if("esri.renderer.ScaleDependentRenderer"===
l.declaredClass&&(l=(f="zoom"===l.rangeType?l.getRendererInfoByZoom(f.getZoom()):l.getRendererInfoByScale(h))&&f.renderer,!l))return!1;f=l&&l.authoringInfo&&"relationship"===l.authoringInfo.type;if("esri.renderer.StretchRenderer"!==l.declaredClass&&"esri.renderer.ShadedReliefRenderer"!==l.declaredClass){var x=this._getVariables(l),H=r.filter(x,function(L){return!!L}).length,w=x[0],D=x[1];x=x[2];if(w){var P=this._getMedianColor(l,w);w.field&&(p=A.isFunction(w.field)?null:this.getField(a,w.field,b));
var X=!(w.legendOptions&&!1===w.legendOptions.showLegend)}if(D){D.field&&(t=A.isFunction(D.field)?null:this.getField(a,D.field,b));var la=!(D.legendOptions&&!1===D.legendOptions.showLegend)}if(x){x.field&&(m=A.isFunction(x.field)?null:this.getField(a,x.field,b));var Z=!(x.legendOptions&&!1===x.legendOptions.showLegend)}}if("esri.renderer.HeatmapRenderer"===l.declaredClass){var V=g=!0;this._showHeatRamp(a,b,l,c)}else if("esri.renderer.DotDensityRenderer"===l.declaredClass)V=g=!0,this._showDotDensityLegend(a,
b,l,c);else if("esri.renderer.TemporalRenderer"===l.declaredClass){V=g=!0;h=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);var Q=k.create("tbody",{},h);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(h,a,b);l.latestObservationRenderer&&"esri.renderer.SimpleRenderer"===l.latestObservationRenderer.declaredClass&&this._buildRow_Renderer(a,l.latestObservationRenderer.symbol,P,B.encode(l.latestObservationRenderer.label)||this.NLS_currentObservations,null,
Q);l.observationRenderer&&"esri.renderer.SimpleRenderer"===l.observationRenderer.declaredClass&&this._buildRow_Renderer(a,l.observationRenderer.symbol,P,B.encode(l.observationRenderer.label)||this.NLS_previousObservations,null,Q)}else if("esri.renderer.UniqueValueRenderer"===l.declaredClass){if(l.infos&&0<l.infos.length){V=g=!0;if(l.legendOptions&&l.legendOptions.title||l.valueExpressionTitle)h=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),Q=k.create("tbody",
{},h),H=l.legendOptions&&l.legendOptions.title?l.legendOptions.title:l.valueExpressionTitle,this._buildRow_Renderer(a,null,P,B.encode(H),null,Q);h=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);Q=k.create("tbody",{},h);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(h,a,b);l.attributeField&&x&&this._addSubHeader(Q,this._getFieldAlias(l.attributeField,a,b));if(f){var aa=l.authoringInfo;var fa=aa.focus;H=aa.numClasses;var ma=aa.field1.field;h=aa.field2.field;
if(H&&ma&&h){var da=aa.field1.normalizationField;aa=aa.field2.normalizationField;var Ia=da&&this._i18n.showNormField||ma&&"${field}",Ja=aa&&this._i18n.showNormField||h&&"${field}";ma=O.substitute({field:this._getFieldAlias(ma,a,b),normField:da&&this._getFieldAlias(da,a,b)},Ia);h=O.substitute({field:this._getFieldAlias(h,a,b),normField:aa&&this._getFieldAlias(aa,a,b)},Ja);da={shapeDescriptor:Ga,rotation:this._getRotationAngleForFocus(fa)||0};this._buildRow_Renderer(a,null,null,B.encode(ma),null,Q,
null,da);da.rotation+=90;this._buildRow_Renderer(a,null,null,B.encode(h),null,Q,null,da);this._drawRelationshipLegend(c,{numClasses:H,focus:fa,uvInfos:l.infos})}}else{var za=[];r.forEach(l.infos,function(L){var ba=null;this._isLayerEditable(a)&&a.types&&(ba=this._getTemplateFromTypes(a.types,L.value));var ha=L.label;null==ha&&(ha=this._getDomainName(l.attributeField,L.value,a,b)||L.value);-1===r.indexOf(za,ha)&&(za.push(ha),this._buildRow_Renderer(a,L.symbol,P,B.encode(ha),ba,Q))},this)}}fa=!f&&this._displayDefaultSymbol(a,
l,c)}else if("esri.renderer.ClassBreaksRenderer"===l.declaredClass){if(l.infos&&0<l.infos.length||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass){V=g=!0;var na=this._isUnclassedRenderer(l);if(!w&&1===l.infos.length)var ca=(ca=l.infos[0])&&ca.symbol;na||(h=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),Q=k.create("tbody",{},h),H=this._getRendererTitle(l,a,b),this._buildRow_Renderer(a,null,P,B.encode(H),null,Q));h=k.create("table",{cellpadding:0,
cellspacing:0,width:"95%","class":"esriLegendLayer"},c);Q=k.create("tbody",{},h);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(h,a,b);na&&x&&Z||(f=l.infos.slice(0).reverse(),r.forEach(f,function(L){var ba=L.label;null!=ba||na||(ba=L.minValue+" - "+L.maxValue);this._buildRow_Renderer(a,L.symbol,P,B.encode(ba),null,Q)},this));"esri.layers.ArcGISImageServiceVectorLayer"!==a.declaredClass||a.renderer.style!==va.STYLE_SCALAR&&a.renderer.style!==va.STYLE_SINGLE_ARROW||(this._buildRow_Renderer(a,
l.defaultSymbol,null,"",null,Q),a._hideDefaultSymbol=!0)}na||(fa=this._displayDefaultSymbol(a,l,c))}else if("esri.renderer.StretchRenderer"===l.declaredClass){V=g=!0;h=k.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},c);Q=k.create("tbody",{},h);var ja=this,sa,ta,Aa=function(){l.statistics.length?(sa=l.statistics[0][1],ta=l.statistics[0][0]):(ta=oa?oa.minValues[0]:a.minValues[0],sa=oa?oa.maxValues[0]:a.maxValues[0]);ja._createStretchLegend(Q,l,ta,sa)};if(a.renderingRule)a.getRenderingRuleServiceInfo(a.renderingRule).then(function(L){var ba=
L&&L.minValues&&0<L.minValues.length&&L.maxValues&&0<L.maxValues.length;L&&1<L.bandCount||!ba?ja._legendRequest(a).then(function(ha){ja._processLegendResponse(a,ha)}):Aa()});else{var oa=a.serviceInfo;if("esri.layers.RasterXLayer"===a.declaredClass&&(oa=a.raster.serviceInfo,a.hasMultidimensions&&!l.statistics.length))return c=a.mosaicRule&&a.mosaicRule.multidimensionalDefinition,a.getStatistics(c&&c.length?c[0].variableName:a._defaultMultidimensionalDefinition[0].variableName).then(A.hitch(this,function(L){this._createStretchLegend(Q,
l,L[0][0],L[0][1]);e()})),g;Aa()}}else"esri.renderer.ShadedReliefRenderer"===l.declaredClass?(V=g=!0,h=k.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},c),Q=k.create("tbody",{},h),this._createStretchLegend(Q,l,0,255)):"esri.renderer.SimpleRenderer"===l.declaredClass?(V=g=!0,h=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),Q=k.create("tbody",{},h),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(h,a,b),ca=null,this._isLayerEditable(a)&&
a.templates&&0<a.templates.length&&(ca=a.templates[0]),f=1<H?null:p&&X||t&&la||m&&Z,this._buildRow_Renderer(a,l.symbol,P,B.encode(f?this._getRampTitle(1<H?null:w||D||x,a,b):l.label),ca,Q),ca=w?null:l.symbol,f&&(p=t=m=null)):"esri.renderer.ColormapRenderer"===l.declaredClass&&(l.colormapInfos&&l.colormapInfos.length&&(V=g=!0),h=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),Q=k.create("tbody",{},h),l.colormapInfos.forEach(function(L){var ba=new wa(wa.STYLE_SOLID,
null,new u(L.color));this._buildRow_Renderer(a,ba,null,L.label,null,Q)},this),a._hideDefaultSymbol=!0);V&&(w&&X&&(w.field||w.valueExpression)&&this._showGradientRamp(a,b,l,null,c,w,p,null,x&&Z?!0:!1),x&&Z&&(x.field||x.valueExpression&&!Ha.test(x.valueExpression))&&(V=w&&X||"esri.renderer.UniqueValueRenderer"===l.declaredClass?!1:!0,this._showSizeLegend(a,b,l,x,P,c,m,null,V)),D&&la&&(D.field||D.valueExpression)&&this._showGradientRamp(a,b,l,ca&&!ca.url&&ca.color?ca.color:this.transparencyRampColor,
c,D,t,null,!1));fa||na&&!X&&!Z&&!la||(fa=this._displayDefaultSymbol(a,l,c));g=g||fa}ja=this;g&&e();return g},_createStretchLegend:function(a,b,c,e){var d=k.create("tr",{},a);var f=k.create("td",{rowspan:2,"class":"esriStretchLegend"},d);b=k.toDom(this._addColorRamp(b.colorRamp));k.place(b,f);k.create("td",{},d).innerHTML=this._i18n.high+": "+Math.round(e*Math.pow(10,3))/Math.pow(10,3);a=k.create("tr",{},a);k.create("td",{},a).innerHTML=this._i18n.low+": "+Math.round(c*Math.pow(10,3))/Math.pow(10,
3)},_addColorRamp:function(a){a||(a={algorithm:"hsv",fromColor:[0,0,0,1],toColor:[255,255,255,1]});var b=this._generateColorRampDivs(a);a.label="\x3cdiv class\x3d'esriStretchLegendGradientLabel'\x3e"+b+"\x3c/div\x3e";return a.label},_generateColorRampDivs:function(a){if(a){var b="";if("multipart"===a.type){var c=100/a.colorRamps.length;var e=a.colorRamps;Object.keys(e).reverse().forEach(function(d){b+=this._generateSingleGradientDiv(e[d].fromColor,e[d].toColor,c)},this)}else b=this._generateSingleGradientDiv(a.fromColor,
a.toColor,100);return b}},_generateSingleGradientDiv:function(a,b,c){if(a&&b){var e="";a=a.toRgb?a.toRgb():a;b=b.toRgb?b.toRgb():b;var d="(0deg, rgb("+a.slice(0,3).join()+"), rgb("+b.slice(0,3).join()+"));";r.forEach(["-webkit-linear-gradient","-o-linear-gradient","-moz-linear-gradient","linear-gradient"],function(f){e+="background: "+f+d});return"\x3cdiv class\x3d'esriStretchLegendSingleGradient' style\x3d'height:"+c+"%;"+e+"'\x3e\x3c/div\x3e"}},_isLayerEditable:function(a){return"function"===typeof a.isEditable&&
a.isEditable()},_isUnclassedRenderer:function(a,b){if("esri.renderer.ClassBreaksRenderer"===a.declaredClass&&a.infos&&1===a.infos.length){var c=a.attributeField;var e=a.normalizationField;c=b?c===b:!!this._getVariables(a,c,e).length}return c},_displayDefaultSymbol:function(a,b,c){if(!a._hideDefaultSymbol&&b.defaultSymbol){var e=!0;c=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);c=k.create("tbody",{},c);this._buildRow_Renderer(a,b.defaultSymbol,null,B.encode(b.defaultLabel)||
"others",null,c)}return e},_showGradientRamp:function(a,b,c,e,d,f,h,g,p){p=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+(p?"":" esriLegendSubFragment")},d);d=k.create("tbody",{},p);(a._hoverLabel||a._hoverLabels||g)&&this._createHoverAction(p,a,b,g);(h||f.valueExpression||f.legendOptions&&f.legendOptions.title)&&this._addSubHeader(d,this._getRampTitle(f,a,b));h=f.field;var m;h&&(m=A.isFunction(h)?null:this.getField(a,h,b));if(f=(b=this._getRampStops(c,f,e,m&&
"esriFieldTypeDate"===m.type))?b.length:0)f=10<f,this._drawGradientRamp(d,b,!f,a,this._getRampBorderColor(c),!!e,f)},_getMedianColor:function(a,b){if(b.colors){var c=b.minDataValue;var e=b.maxDataValue}else b.stops&&(c=b.stops[0].value,e=b.stops[b.stops.length-1].value);return a.getColor(c+(e-c)/2,{colorInfo:b})},_getRampStops:function(a,b,c,e){var d,f,h=!1;if(b.colors||b.opacityValues){var g=b.maxDataValue-b.minDataValue;var p=r.map([0,.25,.5,.75,1],function(x){d=b.minDataValue+x*g;return Number(d.toFixed(6))});
this._checkPrecision(0,4,p)}else b.stops&&(p=r.map(b.stops,function(x){return x.value}),(h=r.some(b.stops,function(x){return!!x.label}))&&(f=r.map(b.stops,function(x){return x.label})));var m=p[0],t,l;g=p[p.length-1]-m;return r.map(p,function(x,H){c?(t=new u(c.toRgba()),l=a.getOpacity(x,{opacityInfo:b}),null!=l&&(t.a=l)):t=a.getColor(x,{colorInfo:b});var w="";if(h)w=f[H];else{w=e?Y.formatDate(x,Y.timelineDateFormatOptions):K.format(x);var D="";0===H?D=this._specialChars.lt+" ":H===p.length-1&&(D=
this._specialChars.gt+" ");w=D+w}return{value:x,color:t,offset:1-(x-m)/g,label:w}},this).reverse()},_checkPrecision:function(a,b,c){var e=a+(b-a)/2,d=c[a],f=c[e],h=c[b],g=Math.floor(d),p=Math.floor(f),m=Math.floor(h);g===d&&m===h&&p!==f&&g!==p&&m!==p&&(c[e]=p);a+1!==e&&this._checkPrecision(a,e,c);e+1!==b&&this._checkPrecision(e,b,c)},_getRampBorderColor:function(a){if("esri.renderer.SimpleRenderer"===a.declaredClass)var b=a.symbol;else if("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===
a.declaredClass)b=a.infos[0].symbol;return(a=b&&-1===b.type.indexOf("linesymbol")?b.getStroke():null)&&a.color},_drawGradientRamp:function(a,b,c,e,d,f,h){var g=k.create("tr",{},a),p=b.length-1,m;var t=0;if(this.alignRight){a=k.create("td",{align:this._isRightToLeft?"left":"right"},g);var l=k.create("td",{align:this._isRightToLeft?"left":"right",width:this.gradientWidth},g)}else l=k.create("td",{width:this.gradientWidth,align:"center"},g),a=k.create("td",{},g);g=d&&0<d.a&&!(240<=d.r&&240<=d.g&&240<=
d.b);var x=k.create("div",{"class":g?"":"esriLegendBorderLessColorRamp",style:"position: relative; width:"+this.gradientWidth+"px;"},l);l=k.create("div",{"class":"esriLegendColorRamp"+(f?" esriLegendTransparencyRamp":"")},x);f=I.get(l,"width");g&&(d=9>v("ie")?d.toHex():"rgba("+d.toRgba().join(",")+")",I.set(l,"border",this.colorRampBorder+" "+d));c?(d=this.gradientHeight*p,I.set(l,"height",d+"px")):d=I.get(l,"height");I.set(x,"height",d+"px");g=z.createSurface(l,f,d);9>v("ie")&&(t=g.getEventSource(),
I.set(t,"position","relative"),I.set(t.parentNode,"position","relative"),t=1);try{c&&r.forEach(b,function(D,P){D.offset=P/p});var H=g.createRect({x:-t,y:-t,width:f+t,height:d+t});H.setFill({type:"linear",x1:0,y1:0,x2:0,y2:d,colors:b}).setStroke(null);g.createRect({width:f,height:d}).setFill(new u([255,255,255,1-e.opacity])).setStroke(null);this._surfaceItems.push(g)}catch(D){g.clear(),g.destroy()}r.forEach(b,function(D,P){D.label&&(m="top:"+100*D.offset+"%;",D="",0===P&&(D+=" esriLegendColorRampTickFirst"),
P===b.length-1&&(D+=" esriLegendColorRampTickLast"),k.create("div",{"class":"esriLegendColorRampTick"+D,innerHTML:"\x26nbsp;",style:m},x))});var w=k.create("div",{"class":"esriLegendColorRampLabels",style:{height:d+this.gradientHeight+"px"}},a);c?r.forEach(b,function(D){k.create("div",{"class":"esriLegendColorRampLabel",innerHTML:B.encode(D.label)||"\x26nbsp;"},w)}):(k.create("div",{"class":"esriLegendColorRampLabel",innerHTML:h?B.encode(b[0].label)||"\x26nbsp;":this._i18n.high},w),k.create("div",
{"class":"esriLegendColorRampLabel",innerHTML:h?B.encode(b[b.length-1].label)||"\x26nbsp;":this._i18n.low,style:"top: "+(d+this.gradientHeight-2*this.gradientHeight)+"px;"},w))},_showHeatRamp:function(a,b,c,e,d){var f=c.field;var h=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e);e=k.create("tbody",{},h);(a._hoverLabel||a._hoverLabels||d)&&this._createHoverAction(h,a,b,d);(f=f&&this.getField(a,f,b))&&this._addSubHeader(e,this._getFieldAlias(f.name,a,b));b=this._getHeatmapStops(c);
b.length&&this._drawGradientRamp(e,b,!1,a)},_getHeatmapStops:function(a){var b=a.colorStops;a=a.colors;if(b&&b[0]){var c=b.length-1;if(a=b[0]&&null!=b[0].ratio)(a=b[c])&&1!==a.ratio&&(b=b.slice(0),b.push({ratio:1,color:a.color}),c++);else{var e=b[0].value;var d=b[c].value-e;b=r.map(b,function(h){return{color:h.color,ratio:(h.value-e)/d}})}}else if(a&&a[0]){c=a.length-1;var f=1/(a.length-1);b=r.map(a,function(h,g){return{color:h,ratio:g*f}})}b=r.map(b,function(h,g){var p="";0===g?p="Low":g===c&&(p=
"High");return{color:h.color,label:p,offset:1-h.ratio}});return b.reverse()},_showDotDensityLegend:function(a,b,c,e){var d=c.legendOptions,f,h=this.dotDensitySwatchSize,g=Math.round(h/2);if(d){var p=d.backgroundColor;var m=d.outline;var t=d.valueUnit;var l=d.dotCoverage}l=(l||this.dotCoverage)/100;var x=Math.round(h*h/Math.pow(c.dotSize,2)*l);e=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e);var H=k.create("tbody",{},e);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(e,
a,b);this._addSubHeader(H,O.substitute({value:c.dotValue,unit:t||""},this.NLS_dotValue));r.forEach(c.fields,function(w){w=A.mixin({},w);w.numPoints=x;f=new Ba(c._generateImageSrc(h,h,[w],{x:0,y:0},{x:h,y:h},p),m||c.outline,h,h);w=this.getField(a,w.name,b)||w;this._buildRow_Renderer(a,f,null,B.encode(this._getFieldAlias(w.name,a,b)),null,H,{type:"path",path:"M "+-g+","+-g+" L "+g+","+-g+" L "+g+","+g+" L "+-g+","+g+" L "+-g+","+-g+" E"})},this)},_showSizeLegend:function(a,b,c,e,d,f,h,g,p){var m=e.legendOptions;
m=m&&m.customValues;d=this._getSizeSymbol(c,d);if((!e.valueUnit||"unknown"===e.valueUnit)&&d&&(m||null!=e.minSize&&null!=e.maxSize&&null!=e.minDataValue&&null!=e.maxDataValue||e.stops&&!(1>=e.stops.length))){p=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+(p?"":" esriLegendSubFragment")},f);f=k.create("tbody",{},p);(a._hoverLabel||a._hoverLabels||g)&&this._createHoverAction(p,a,b,g);(h||e.valueExpression||e.legendOptions&&e.legendOptions.title)&&this._addSubHeader(f,
this._getRampTitle(e,a,b));h=(p=(g=e.field)&&!A.isFunction(g))&&"cluster_count"===g.toLowerCase();b=(b=p?a.isFeatureReductionActive&&a.isFeatureReductionActive()?a.getFeatureReductionField(g):this.getField(a,g,b):null)&&"esriFieldTypeDate"===b.type;m=m||this._getDataValues(c,d,e,b,h);var t=m.length-1;for(g=t;0<=g;g--){p=m[g];d=qa.fromJson(d.toJson());this._applySize(d,c,e,p);p=b?Y.formatDate(p,Y.timelineDateFormatOptions):K.format(p);var l="";g===t?l=this._specialChars.gt+" ":0===g&&(l=h&&1===m[g]?
"":this._specialChars.lt+" ");l="\x3cspan class\x3d'esriLegendSizeRampLabel'\x3e"+B.encode(l+p)+"\x3c/span\x3e";this._buildRow_Renderer(a,d,null,l,null,f)}}},_getSizeSymbol:function(a,b){if("esri.renderer.SimpleRenderer"===a.declaredClass)var c=a.symbol;else if("esri.renderer.VectorFieldRenderer"===a.declaredClass)c=a.defaultSymbol;else if("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass){c=a.infos[0].symbol;var e=1<a.infos.length}if(c=c&&
-1!==c.type.indexOf("fillsymbol")?null:c)if(c=qa.fromJson(c.toJson()),b||e)-1!==c.type.indexOf("linesymbol")?c.setColor(new u(this.sizeRampDarkColor)):(c.setColor(new u(this.sizeRampLightColor)),c.setOutline&&(a=new ra,a.setColor(new u(this.sizeRampDarkColor)),a.setWidth(1.5),c.setOutline(a)));return c},_getDataValues:function(a,b,c,e,d){if(d){var f;r.some([5,3,2],function(h){h=this._getDataValuesByCount(a,b,c,e,h);this._hasFractionalValues(h)||(f=h);return!!f},this);return f}return this._getDataValuesByCount(a,
b,c,e,5)},_getDataValuesByCount:function(a,b,c,e,d,f){d=null==d?5:d;f=null==f?20:f;var h=a.getSizeRangeAtScale(c,this.map.getScale());d=this._interpolateSizeRange(h,d);var g=this._getDataRange(c),p=r.map(d,function(t){return this._getDataValueFromSize(t,g,h)},this);if(!e){var m;p=K.round(p);for(e=1;e<p.length-1;e++)if(m=this._roundDataValue(a,b,c,p[e],p[e-1],f))p[e]=m[0],d[e]=m[1]}return p},_hasFractionalValues:function(a){return r.some(a,function(b){return b!==Math.floor(b)})},_getDataRange:function(a){var b=
a.stops;return b?{min:b[0].value,max:b[b.length-1].value}:{min:a.minDataValue,max:a.maxDataValue}},_interpolateSizeRange:function(a,b){var c=a.minSize;a=(a.maxSize-c)/(b-1);var e,d=[];for(e=0;e<b;e++)d.push(c+a*e);return d},_getDataValueFromSize:function(a,b,c){var e=c.minSize;c=c.maxSize;var d=b.min;b=b.max;return a<=e?d:a>=c?b:(a-e)/(c-e)*(b-d)+d},_roundDataValue:function(a,b,c,e,d,f){var h=this._getSize(b,a,c,e);d=this._getSize(b,a,c,d);var g=K.getDigits(e),p=g.integer;g=g.fractional;var m;if(0<
e&&1>e){var t=Math.pow(10,g);e*=t;p=K.getDigits(e).integer}for(--p;0<=p;p--){var l=Math.pow(10,p);g=Math.floor(e/l)*l;l*=Math.ceil(e/l);null!=t&&(g/=t,l/=t);var x=(g+l)/2;x=K.round([g,x,l],{indexes:[1]})[1];var H=this._getSize(b,a,c,g);var w=this._getSize(b,a,c,l);var D=this._getSize(b,a,c,x);var P=K.getPctChange(h,H,d,null);var X=K.getPctChange(h,w,d,null);var la=K.getPctChange(h,D,d,null);var Z=P.prev<=f;var V=X.prev<=f;Z&&V&&(P.prev<=X.prev?(Z=!0,V=!1):(V=!0,Z=!1));Z?m=[g,H]:V?m=[l,w]:la.prev<=
f&&(m=[x,D]);if(m)break}return m},_applySize:function(a,b,c,e){var d=a.type;b=this._getSize(a,b,c,e);switch(d){case "simplemarkersymbol":a.setSize(b);break;case "picturemarkersymbol":d=a.width;c=a.height;a.setHeight(b);a.setWidth(d/c*b);break;case "simplelinesymbol":case "cartographiclinesymbol":a.setWidth(b);break;case "textsymbol":a.font&&a.font.setSize(b)}},_getSize:function(a,b,c,e){return b.getSize(e,{sizeInfo:c,scale:this.map.getScale(),shape:-1!==a.type.indexOf("markersymbol")?a.style:null})},
_buildRow_Renderer:function(a,b,c,e,d,f,h,g){var p=!!g,m=k.create("tr",{},f);if(this.alignRight){if(f=k.create("td",{align:this._isRightToLeft?"left":"right"},m),b||p)var t=k.create("td",{align:this._isRightToLeft?"left":"right",width:35},m)}else{if(b||p)t=k.create("td",{width:35,align:"center"},m);f=k.create("td",{},m)}var l=m=30;if(b)if("simplemarkersymbol"==b.type)m=Math.min(Math.max(m,b.size+12),125),l=Math.min(Math.max(l,b.size+12),125);else if("picturemarkersymbol"==b.type)m=Math.min(Math.max(m,
b.width),125),l=Math.min(b.height||l,125);else if("textsymbol"==b.type){if(!b.text){var x=b.text;var H=!0;b.setText(this.defaultText)}m=Math.min(Math.max(m,b.getWidth()+12),125);l=Math.min(Math.max(l,b.getHeight()+12),125);H&&b.setText(x)}if(b||p)var w=k.create("div",{style:"width:"+m+"px;height:"+l+"px;"},t);O.isDefined(e)&&"number"===typeof e&&(e=""+e);k.create("td",{innerHTML:e||"",align:this._align},k.create("tr",{},k.create("tbody",{},k.create("table",{width:"95%"},f))));if(b||p)a=this._drawSymbol(w,
b,c,m,l,d,a,h,g),this._surfaceItems.push(a)},_addSubHeader:function(a,b){a=k.create("tr",{},a);a=k.create("td",{align:this._align,colspan:2},a);k.create("td",{innerHTML:B.encode(b)||"",align:this._align},k.create("tr",{},k.create("tbody",{},k.create("table",{width:"95%"},a))))},_drawSymbol:function(a,b,c,e,d,f,h,g,p){var m=b&&qa.fromJson(b.toJson()),t=h.opacity;b=!!p;if(m)if(c&&m.setColor(new u(c.toRgba())),"simplelinesymbol"===m.type||"cartographiclinesymbol"===m.type||"textsymbol"===m.type){if(!m.color)return;
c=m.color.toRgba();c[3]*=t;m.color.setColor(c)}else"simplemarkersymbol"===m.type||"simplefillsymbol"===m.type?(m.color&&(c=m.color.toRgba(),c[3]*=t,m.color.setColor(c)),m.outline&&m.outline.color&&(c=m.outline.color.toRgba(),c[3]*=t,m.outline.color.setColor(c))):"picturemarkersymbol"===m.type&&(a.style.opacity=t,a.style.filter="alpha(opacity\x3d("+100*t+"))");a=z.createSurface(a,e,d);9>v("ie")&&(c=a.getEventSource(),I.set(c,"position","relative"),I.set(c.parentNode,"position","relative"));f=b?p.shapeDescriptor:
this._getDrawingToolShape(m,f)||qa.getShapeDescriptors(m);t=(c=f.defaultShape)&&"text"===c.type;try{t&&!c.text&&(c.text=this.defaultText);var l=a.createShape(g||c).setFill(f.fill).setStroke(f.stroke);t&&l.setFont(f.font)}catch(w){a.clear();a.destroy();return}var x=l.getBoundingBox();g=x.width;f=x.height;t=-(x.x+g/2);var H=-(x.y+f/2);c=a.getDimensions();t={dx:t+c.width/2,dy:H+c.height/2};if(m&&"simplemarkersymbol"===m.type&&"path"===m.style)e=h._getScaleMatrix(x,m.size),l.applyTransform(C.scaleAt(e.xx,
e.yy,{x:c.width/2,y:c.height/2}));else if(g>e||f>d)h=g/e>f/d,e=((h?e:d)-5)/(h?g:f),A.mixin(t,{xx:e,yy:e});l.applyTransform(t);b&&l.applyTransform(C.rotategAt(p.rotation,g/2,f/2));return a},_getDrawingToolShape:function(a,b){switch(b?b.drawingTool||null:null){case "esriFeatureEditToolArrow":b={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 Z"};break;case "esriFeatureEditToolTriangle":b={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 Z"};break;case "esriFeatureEditToolRectangle":b=
{type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 Z"};break;case "esriFeatureEditToolCircle":b={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":b={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null}return{defaultShape:b,fill:a.getFill(),stroke:a.getStroke()}},_drawRelationshipLegend:function(a,b){var c=b.focus,e=b.numClasses,d=Fa[e],f=!!c,h=Math.sqrt(Math.pow(75,2)+Math.pow(75,2)),g={};b.uvInfos.forEach(function(l){g[l.value]={label:l.label,fill:this._getSymbolColor(l.symbol)}},
this);b=[];for(var p=0;p<e;p++){for(var m=[],t=0;t<e;t++)m.push(g[d[p][t]].fill);b.push(m)}d=this._getRelationshipCornerLabels(c,g);a=this._drawRampLayout(a,d,h,f);a=z.createSurface(a,h,h);f||(a.rawNode.style.margin="-15px -15px -18px -15px");b=Ca.create2DColorRamp({surface:a,colors:b,numClasses:e,size:75});e=(h-75)/2;h=(h-75)/2;b.applyTransform(C.translate(e,h));f&&b.applyTransform(C.rotategAt(this._getRotationAngleForFocus(c),37.5,37.5));b=a.createGroup();d={width:1,color:"#555555"};p=a.defNode;
this._createArrowMarker(p,"start");this._createArrowMarker(p,"end");p=b.createLine({x1:-10,y1:60,x2:-10,y2:15}).setStroke(d);d=b.createLine({x1:15,y1:85,x2:60,y2:85}).setStroke(d);this._setLineArrow(p.rawNode,"left",c);this._setLineArrow(d.rawNode,"right",c);b.applyTransform(C.translate(e,h));f&&b.applyTransform(C.rotategAt(-45,37.5,37.5));this._surfaceItems.push(a)},_drawRampLayout:function(a,b,c,e){var d=k.create("div",{style:{padding:"10px"}},a);a=c+"px";c+="px";e?(e=k.create("div",{style:{display:"flex"}},
d),k.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a,textAlign:"right"},innerHTML:b.left},e),d=k.create("div",{style:{display:"flex",flexDirection:"column",textAlign:"center"}},e),k.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a},innerHTML:b.right},e),e=k.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a},innerHTML:b.top},d),e=k.create("div",{style:{height:c,width:c}},d),d=k.create("div",
{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a},innerHTML:b.bottom},d)):(d=k.create("div",{style:{display:"table",color:"#555555"}},d),e=k.create("div",{style:{display:"table-row"}},d),c=k.create("div",{style:{display:"table-row"}},d),d=k.create("div",{style:{display:"table-row"}},d),k.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"right",verticalAlign:"bottom"},innerHTML:b.left},e),k.create("div",{style:{display:"table-cell"}},
e),k.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"left",verticalAlign:"bottom"},innerHTML:b.top},e),k.create("div",{style:{display:"table-cell"}},c),e=k.create("div",{style:{display:"table-cell"}},c),k.create("div",{style:{display:"table-cell"}},c),k.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"right",verticalAlign:"top"},innerHTML:b.bottom},d),k.create("div",{style:{display:"table-cell"}},
d),k.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"left",verticalAlign:"top"},innerHTML:b.right},d));return e},_getSymbolColor:function(a){if(a)return"simplelinesymbol"===a.type||"simplemarkersymbol"===a.type&&(a.style===pa.STYLE_X||a.style===pa.STYLE_CROSS)?(a=a.getStroke())&&a.color:a.getFill()},_getRotationAngleForFocus:function(a){var b=ya[a];a&&null==b&&(b=ya.HH);return b},_setLineArrow:function(a,b,c){var e=this.id+"_arrowStart",d=this.id+
"_arrowEnd";b="left"===b;switch(c){case "HL":a.setAttribute(b?"marker-start":"marker-end","url(#"+(b?d:e)+")");break;case "LL":a.setAttribute("marker-start","url(#"+d+")");break;case "LH":a.setAttribute(b?"marker-end":"marker-start","url(#"+(b?e:d)+")");break;default:a.setAttribute("marker-end","url(#"+e+")")}},_createArrowMarker:function(a,b){var c="start"===b,e=this.id+(c?"_arrowStart":"_arrowEnd");b=c?"0,0 5,5 0,10":"5,0 0,5 5,10";var d=c?5:0;c=document.createElementNS("http://www.w3.org/2000/svg",
"marker");c.setAttribute("id",e);c.setAttribute("markerWidth","10");c.setAttribute("markerHeight","10");c.setAttribute("refX",d);c.setAttribute("refY","5");c.setAttribute("markerUnits","strokeWidth");c.setAttribute("orient","auto");e=document.createElementNS("http://www.w3.org/2000/svg","polyline");e.setAttribute("points",b);e.setAttribute("fill","none");e.setAttribute("stroke","#555555");e.setAttribute("stroke-width","1");c.appendChild(e);a.appendChild(c)},_getRelationshipCornerLabels:function(a,
b){var c=b.HH.label,e=b.LL.label,d=b.HL.label;b=b.LH.label;switch(a){case "HH":return{top:c,bottom:e,left:d,right:b};case "HL":return{top:d,bottom:b,left:e,right:c};case "LL":return{top:e,bottom:c,left:b,right:d};case "LH":return{top:b,bottom:d,left:c,right:e};default:return{top:c,bottom:e,left:d,right:b}}},_repaintItems:function(){r.forEach(this._surfaceItems,function(a){this._repaint(a)},this)},_repaint:function(a){if(a){a.getStroke&&a.setStroke&&a.setStroke(a.getStroke());try{a.getFill&&a.setFill&&
a.setFill(a.getFill())}catch(b){}a.children&&A.isArray(a.children)&&r.forEach(a.children,this._repaint,this)}},_createHoverAction:function(a,b,c,e){if(e=b._hoverLabel||b._hoverLabels&&b._hoverLabels[c.id]||e)e=B.encode(e),b.mouseMoveHandler=b.mouseMoveHandler||{},b.mouseMoveHandler[c.id]=G.connect(a,"onmousemove",A.hitch(this,function(d,f){this.mouseX=f.clientX;this.mouseY=f.clientY;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,I.set(E.byId(this.id+"_hoverLabel"),"display","none"));setTimeout(A.hitch(this,
function(h,g,p){if(h==this.mouseX&&g==this.mouseY&&!this.hoverLabelShowing)if(this.hoverLabelShowing=!0,E.byId(this.id+"_hoverLabel")){var m=E.byId(this.id+"_hoverLabel");m.innerHTML="\x3cspan\x3e"+p+"\x3c/span\x3e";I.set(m,"top",g+"px");I.set(m,"left",h+15+"px");I.set(m,"display","")}else k.create("div",{innerHTML:"\x3cspan\x3e"+p+"\x3c/span\x3e",id:this.id+"_hoverLabel","class":"esriLegendHoverLabel",style:{top:g+"px",left:h+15+"px"}},document.body)},f.clientX,f.clientY,d),500)},e)),b.mouseOutHandler=
b.mouseOutHandler||{},b.mouseOutHandler[c.id]=G.connect(a,"onmouseout",A.hitch(this,function(d){this.mouseY=this.mouseX=-1;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,I.set(E.byId(this.id+"_hoverLabel"),"display","none"))}))},_removeHoverHandlers:function(){var a;r.forEach(this.layers,function(b){if(b.mouseMoveHandler)for(a in b.mouseMoveHandler)G.disconnect(b.mouseMoveHandler[a]);if(b.mouseOutHandler)for(a in b.mouseOutHandler)G.disconnect(b.mouseOutHandler[a])})},_createDynamicLayers:function(a){var b=
[],c;r.forEach(a.dynamicLayerInfos||a.layerInfos,function(e){c={id:e.id};c.source=e.source&&e.source.toJson();var d;a.layerDefinitions&&a.layerDefinitions[e.id]&&(d=a.layerDefinitions[e.id]);d&&(c.definitionExpression=d);var f;a.layerDrawingOptions&&a.layerDrawingOptions[e.id]&&(f=a.layerDrawingOptions[e.id]);f&&(c.drawingInfo=f.toJson());c.minScale=e.minScale||0;c.maxScale=e.maxScale||0;b.push(c)});return b},_getTemplateFromTypes:function(a,b){var c;for(c=0;c<a.length;c++)if(a[c].id==b&&a[c].templates&&
0<a[c].templates.length)return a[c].templates[0];return null},_findParentGroup:function(a,b,c){var e,d=b.dynamicLayerInfos||b.layerInfos;for(e=0;e<d.length;e++)if(c==d[e].id){-1<d[e].parentLayerId&&(I.set(E.byId(this.id+"_"+a+"_"+d[e].parentLayerId+"_group"),"display","block"),this._findParentGroup(a,b,d[e].parentLayerId));break}},_addSubLayersToHide:function(a){function b(c,e){var d=a.layer.dynamicLayerInfos||a.layer.layerInfos,f,h;for(f=0;f<d.length;f++)if(d[f].id===c&&d[f].subLayerIds)for(h=0;h<
d[f].subLayerIds.length;h++){var g=d[f].subLayerIds[h];-1===r.indexOf(e,g)&&(e.push(g),b(g,e))}}a.layer.layerInfos&&r.forEach(this.hideLayersInLegend[a.layer.id],function(c){b(c,this.hideLayersInLegend[a.layer.id])},this)},_isLayerInScale:function(a,b,c){var e,d=!0;if(a.legendResponse&&a.legendResponse.layers)for(e=0;e<a.legendResponse.layers.length;e++){var f=a.legendResponse.layers[e];if(b.id==f.layerId){if(!a.minScale&&0!==a.minScale||!a.maxScale&&0!==a.maxScale){if(0==f.minScale&&a.tileInfo)var h=
a.tileInfo.lods[0].scale;if(0==f.maxScale&&a.tileInfo)var g=a.tileInfo.lods[a.tileInfo.lods.length-1].scale}else h=Math.min(a.minScale,f.minScale)||a.minScale||f.minScale,g=Math.max(a.maxScale,f.maxScale);if(0<h&&h<c||g>c)d=!1;break}}else if(a.minScale||a.maxScale)if(a.minScale&&a.minScale<c||a.maxScale&&a.maxScale>c)d=!1;return d},_getServiceTitle:function(a){var b=a._titleForLegend;b||(b=a.url,a.url?-1<a.url.indexOf("/MapServer")?(b=a.url.substring(0,a.url.indexOf("/MapServer")),b=b.substring(b.lastIndexOf("/")+
1,b.length)):-1<a.url.indexOf("/ImageServer")?(b=a.url.substring(0,a.url.indexOf("/ImageServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/FeatureServer")&&(b=a.url.substring(0,a.url.indexOf("/FeatureServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):b="",a.name&&(b=0<b.length?b+(" - "+a.name):a.name));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&a.vectorFieldPixelFilter&&(a=a.vectorFieldPixelFilter.outputUnit?this["NLS_"+a.vectorFieldPixelFilter.outputUnit]:
this["NLS_"+a.vectorFieldPixelFilter.inputUnit],O.isDefined(a)&&(b+=" ("+a+")"));return B.encode(b)},_getEffectiveScale:function(a,b){var c=b.minScale,e=b.maxScale;if(O.isDefined(b.parentLayerId)){a=a.layerInfos;b=b.parentLayerId;var d;for(d=a.length-1;0<=d;d--)if(a[d].id==b)if(0==c&&0<a[d].minScale?c=a[d].minScale:0<c&&0==a[d].minScale||0<c&&0<a[d].minScale&&(c=Math.min(c,a[d].minScale)),e=Math.max(e||0,a[d].maxScale||0),-1<a[d].parentLayerId)b=a[d].parentLayerId;else break}return{minScale:c,maxScale:e}},
_isSupportedLayerType:function(a){return!(!a||!("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.2<=a.version||"esri.layers.RasterXLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass||"esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass||"esri.layers.KMLLayer"===a.declaredClass||"esri.layers.GeoRSSLayer"===
a.declaredClass||"esri.layers.WMSLayer"===a.declaredClass||"esri.layers.WFSLayer"===a.declaredClass||"esri.layers.CSVLayer"===a.declaredClass))},isHostedTileService:function(a){var b=/(https?:)?\/\/services.*\.arcgis\.com/i;return!("esri.layers.ArcGISTiledMapServiceLayer"!==a.declaredClass||!b.test(a.url))},getField:function(a,b,c){if(a.getField)return a.getField(b);if(c&&c.fields){var e;r.forEach(c.fields,function(d){d.name===b&&(e=d)});return e}return null}});A.mixin(ea,{ALIGN_LEFT:0,ALIGN_RIGHT:1});
v("extend-esri")&&A.setObject("dijit.Legend",ea,F);return ea});